<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <meta charset="utf-8"/>
  <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
  <title>Stellantis - Controle de Lacres</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
  <style>
    :root { --cor-fundo: #0b1d30; --cor-caixa: #1c2b3d; --cor-primaria: #3366ff; --cor-hover: #1a4ed8; --cor-texto: #ffffff; --cor-alerta: #f0ad4e; --cor-erro: #ff4444; --fonte: 'Inter', sans-serif; }
    * { box-sizing: border-box; }
    body { margin: 0; font-family: var(--fonte); background-color: var(--cor-fundo); color: var(--cor-texto); padding: 1rem; }
    .container { max-width: 920px; margin: auto; background: var(--cor-caixa); padding: 2rem; border-radius: 20px; display: flex; flex-direction: column; gap: 1.5rem; }
    h1, h2, h3 { text-align: center; margin: 0; }
    h1 { font-size: 2rem; color: var(--cor-texto); letter-spacing: 2px; }
    h2 { font-size: 1.4rem; color: var(--cor-texto); opacity: 0.85; }
    h3 { font-size: 1.2rem; color: var(--cor-primaria); opacity: 0.85; }
    label { font-weight: 600; font-size: 0.95rem; display: flex; flex-direction: column; margin-top: .5rem; }
    input, select { margin-top: .4rem; padding: .7rem; border: 1px solid #3366ff33; border-radius: 8px; font-size: 1rem; background: #101d30; color: #fff; }
    input:focus, select:focus { outline: 2px solid #3366ff; }
    .button-group { display: flex; flex-wrap: wrap; justify-content: center; gap: .75rem; }
    button { background: var(--cor-primaria); color: #fff; border: none; padding: .75rem 1.5rem; border-radius: 10px; font-size: 1rem; font-weight: 600; display: inline-flex; align-items: center; gap: .5rem; cursor: pointer; transition: background .2s; }
    button:hover { background: var(--cor-hover); }
    .auto-save-icon { text-align: right; font-size: .85rem; color: #55dd55; }
    .info { font-weight: bold; text-align: center; color: var(--cor-alerta); }
    .warning { color: var(--cor-erro); font-size: .9rem; }
    table { width: 100%; border-collapse: collapse; margin-top: 1rem; font-size: .95rem; }
    th, td { border: 1px solid #2e3c51; padding: .6rem; text-align: center; color: var(--cor-texto); }
    th { background: #233246; color: var(--cor-primaria); }
    @media (max-width: 600px) { .container { padding: 1rem; } .button-group { flex-direction: column; } button { width: 100%; justify-content: center; } .auto-save-icon { text-align: center; margin-top: .5rem; } }
  
/* --- UX additions --- */
button { min-height: 48px; }
tbody tr:nth-child(even) { background: #192739; }
tbody tr:hover { background: #20324a; }
thead th { position: sticky; top: 0; z-index: 2; }
#toastContainer { position: fixed; bottom: 16px; left: 50%; transform: translateX(-50%); z-index: 10000; display: flex; flex-direction: column; gap: 8px; align-items: center; }
.toast { padding: 10px 14px; border-radius: 10px; background: #22364d; color: #fff; box-shadow: 0 6px 24px rgba(0,0,0,.35); font-weight: 600; }
.toast.success { border-left: 4px solid #3ddc84; }
.toast.warn { border-left: 4px solid #f0ad4e; }
.toast.error { border-left: 4px solid #ff4444; }
#confirmOverlay { position: fixed; inset: 0; background: rgba(0,0,0,.5); display: none; align-items: center; justify-content: center; z-index: 11000; }
#confirmBox { background: #142132; padding: 18px; border-radius: 16px; max-width: 420px; width: calc(100% - 32px); color: #fff; }
#confirmBox .title { font-weight: 700; margin-bottom: 8px; }
#confirmBox .actions { display: flex; gap: 10px; justify-content: flex-end; margin-top: 12px; }
#confirmBox button { min-height: 40px; }
</style>

</head>
<body>
<div style="position:fixed;top:16px;right:16px;z-index:9999;cursor:pointer;" onclick="window.location.href='interface_principal.html';" title="Sair">
  <svg fill="#00d2ff" height="30" viewBox="0 0 24 24" width="30" xmlns="http://www.w3.org/2000/svg"><path d="M16 13v-2H7V8l-5 4 5 4v-3h9z"/><path d="M20 3H10v2h10v14H10v2h10a2 2 0 0 0 2-2V5a2 2 0 0 0-2-2z"/></svg>
</div>
  <div class="container">
    <h1 style="font-family: 'Orbitron'; font-size: 2.2rem; letter-spacing: 6px; color: #00faff; font-weight: 800;">STELLANTIS</h1>
    <h2 style="font-size: 1.3rem; font-weight: 600; letter-spacing: 3px; text-transform: uppercase; color: #00d2ff; opacity: .85; margin-top: .3rem;">Seguran√ßa Patrimonial</h2>
    <h3 style="font-size: 1.1rem; font-weight: 400; color: #ffffffcc; margin-bottom: 1rem;">Controle de Lacres</h3>
    <label>Setor:
      <select id="setor">
        <option>Caixaria G08</option>
        <option>Caixaria G89</option>
      </select>
    </label>
    <label>Turno:<select id="turno"><option>1¬∫</option><option>2¬∫</option><option>3¬∫</option></select></label>
    <label>N√∫mero do lacre:<input id="numeroLacre" type="number" inputmode="numeric" pattern="[0-9]*"/><div class="warning" id="alertaRepetido"></div></label>
    <label>Quantidade de lacres (m√°x. 100):<input id="quantidadeLacres" type="number" inputmode="numeric" pattern="[0-9]*"/><div class="warning" id="alertaQuantidade"></div></label>
    <label>Conferente/Registro:
  <input id="conferente" type="text"/>
</label>
    <label>Auxiliar log√≠stico:<input id="auxiliar" type="text"/></label>
    <div class="info" id="info"></div>
    <div class="auto-save-icon">üíæ Salvamento autom√°tico</div>
    <div class="button-group">
      <button onclick="adicionarLacres()">‚ûï Adicionar</button>
      <button onclick="gerarPlanilha()">üìÑ Gerar Excel</button>
      <button onclick="desfazerUltimo()">‚Ü©Ô∏è Desfazer</button>
      <button onclick="desfazerTudo()">üóëÔ∏è Desfazer Tudo</button>
      <button onclick="finalizarTurno()">‚úÖ Finalizar Turno</button>
      <button id="toggleTableBtn" onclick="toggleTable()">üëÅÔ∏è Visualizar tabela</button>
    </div>
    <div id="toastContainer" aria-live="polite"></div>
<div id="confirmOverlay" role="dialog" aria-modal="true"><div id="confirmBox"><div class="title">Confirma√ß√£o</div><div id="confirmMessage">Tem certeza?</div><div class="actions"><button id="confirmCancelBtn" style="background:#2e3c51">Cancelar</button><button id="confirmOkBtn">Confirmar</button></div></div></div>
    <table id="tabelaLacres"><thead><tr><th>Setor</th><th>Turno</th><th>N¬∞ Lacre</th><th>Conferente</th><th>Auxiliar log√≠stico</th><th>Data e Hora</th></tr></thead><tbody></tbody></table>
  </div>

<script>
let lacres = JSON.parse(localStorage.getItem("lacres") || "[]");
let actionHistory = JSON.parse(localStorage.getItem("actionHistory") || "[]");

window.saveState = function () {
  localStorage.setItem("lacres", JSON.stringify(lacres));
  localStorage.setItem("actionHistory", JSON.stringify(actionHistory));
};

window.atualizarTabela = function () {
  const tbody = document.querySelector("#tabelaLacres tbody");
  tbody.innerHTML = "";
  lacres.forEach(item => {
    const tr = document.createElement("tr");
    ["setor", "turno", "numeroLacre", "conferente", "auxiliar", "dataHora"].forEach(key => {
      const td = document.createElement("td");
      td.textContent = item[key] || "";
      tr.appendChild(td);
    });
    tbody.appendChild(tr);
  });
  const info = document.getElementById("info");
  info.textContent = lacres.length ? `√öltimo lacre: ${lacres[lacres.length - 1].numeroLacre} | Total: ${lacres.length}` : ""; const btn=document.getElementById("toggleTableBtn"); if(btn){ const base = (document.getElementById("tabelaLacres").style.display==="none")?"üëÅÔ∏è Visualizar tabela":"üö´ Esconder tabela"; btn.textContent = `${base} (${lacres.length})`; }
};

window.adicionarLacres = function () {
  const setor = document.getElementById("setor").value;
  const turno = document.getElementById("turno").value;
  const inicio = Number(document.getElementById("numeroLacre").value);
  const qtd = Number(document.getElementById("quantidadeLacres").value);
  const conferente = document.getElementById("conferente").value;
  const auxiliar = document.getElementById("auxiliar").value;
  const alertaRepetido = document.getElementById("alertaRepetido");
  alertaRepetido.textContent = "";

  if (!setor || !turno || isNaN(inicio) || isNaN(qtd) || qtd < 1 || !conferente) return;

  let repetido = false;
  for (let i = 0; i < qtd; i++) {
    let numeroAtual = String(inicio + i);
    if (lacres.some(item => item.numeroLacre === numeroAtual)) {
      repetido = true;
      break;
    }
  }

  if (repetido) {
    alertaRepetido.textContent = "Existe(m) n√∫mero(s) de lacre repetido(s)! Corrija para continuar.";
    return;
  }

  const items = [];
  for (let i = 0; i < qtd; i++) {
    const item = {
      setor,
      turno,
      numeroLacre: String(inicio + i),
      conferente,
      auxiliar,
      dataHora: new Date().toLocaleString('pt-BR')
    };
    lacres.push(item);
    items.push(item);
  }

  const proximo = inicio + qtd;
  localStorage.setItem("numeroLacre", proximo);
  document.getElementById("numeroLacre").value = proximo;
  document.getElementById("numeroLacre").focus();
  localStorage.setItem("quantidadeLacres", qtd);
  localStorage.setItem("auxiliar", auxiliar);

  actionHistory.push({ type: "add", items });
  saveState();
  atualizarTabela();
};


function atualizarCampoNumeroLacre() {
  if (lacres.length > 0) {
    const ultimo = Number(lacres[lacres.length - 1].numeroLacre);
    document.getElementById("numeroLacre").value = ultimo + 1;
  } else {
    document.getElementById("numeroLacre").value = "";
  }
}

window.desfazerUltimo = function () {
  if (lacres.length === 0) return;
  const removido = lacres.pop();
  actionHistory.push({ type: "remove", items: [removido] });
  saveState();
  atualizarTabela();
  atualizarCampoNumeroLacre();
};

window.desfazerTudo = function () {
  if (actionHistory.length === 0) return;
  const last = actionHistory.pop();
  if (last.type === "add") {
    lacres.splice(-last.items.length, last.items.length);
  } else if (last.type === "remove") {
    lacres.push(...last.items);
  }
  saveState();
  atualizarTabela();
  atualizarCampoNumeroLacre();
};


window.gerarPlanilha = function () {
  if (lacres.length === 0) return;

  // Build main data
  const dados = lacres.map(item => ({
    "Setor": item.setor,
    "Turno": item.turno,
    "N¬∞ Lacre": item.numeroLacre,
    "Conferente": item.conferente,
    "Auxiliar log√≠stico": item.auxiliar,
    "Data e Hora": item.dataHora
  }));

  // Create worksheet starting at A2 and title at A1
  const ws = XLSX.utils.json_to_sheet(dados, { origin: "A2" });
  XLSX.utils.sheet_add_aoa(ws, [["Stellantis - Controle de Lacres", new Date().toLocaleString('pt-BR')]], { origin: "A1" });
  // Merge title across A1:F1
  if (!ws["!merges"]) ws["!merges"] = [];
  ws["!merges"].push({ s: { r:0, c:0}, e: { r:0, c:5 } });
  // Add TOTAL row with formula counting N¬∞ Lacre (column C)
  const startRow = 3; // data starts at row 3
  const lastDataRow = startRow + dados.length - 1;
  const totalRow = lastDataRow + 1;
  const totalLabelCell = XLSX.utils.encode_cell({ r: totalRow-1, c: 4 }); // E{totalRow}
  const totalValueCell = XLSX.utils.encode_cell({ r: totalRow-1, c: 5 }); // F{totalRow}
  ws[totalLabelCell] = { t: "s", v: "TOTAL" };
  ws[totalValueCell] = { t: "n", f: `COUNTA(C${startRow}:C${lastDataRow})` };

  // Optional column widths and title height
  ws['!cols'] = [
    { wch: 20 }, { wch: 10 }, { wch: 15 }, { wch: 25 }, { wch: 25 }, { wch: 22 }
  ];
  ws["!rows"] = ws["!rows"] || [];
  ws["!rows"][0] = { hpt: 24 };

  // Build "Resumo" sheet (totais por Setor e Turno)
  const resumoMap = {};
  lacres.forEach(it => {
    const key = `${it.setor}|||${it.turno}`;
    resumoMap[key] = (resumoMap[key] || 0) + 1;
  });
  const resumoData = [["Resumo por Setor e Turno"], ["Setor","Turno","Total"]];
  Object.entries(resumoMap).forEach(([k, total]) => {
    const [setor, turno] = k.split("|||");
    resumoData.push([setor, turno, total]);
  });
  const wsResumo = XLSX.utils.aoa_to_sheet(resumoData);
  // Merge title across first row (A1:C1)
  wsResumo["!merges"] = wsResumo["!merges"] || [];
  wsResumo["!merges"].push({ s:{r:0,c:0}, e:{r:0,c:2} });
  wsResumo['!cols'] = [{ wch: 24 }, { wch: 10 }, { wch: 10 }];
  wsResumo["!rows"] = [{ hpt: 24 }];

  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, "Lacres");
  XLSX.utils.book_append_sheet(wb, wsResumo, "Resumo");

  // Dynamic filename: setor_turno_dataHora
  const setorAtual = (document.getElementById("setor")?.value || "Setor").replace(/\s+/g, "_");
  const turnoAtual = (document.getElementById("turno")?.value || "Turno").replace(/\s+/g, "_");
  const agora = new Date();
  const ts = `${agora.getFullYear()}-${String(agora.getMonth()+1).padStart(2,"0")}-${String(agora.getDate()).padStart(2,"0")}_${String(agora.getHours()).padStart(2,"0")}-${String(agora.getMinutes()).padStart(2,"0")}`;
  const filename = `lacres_${setorAtual}_${turnoAtual}_${ts}.xlsx`;

  XLSX.writeFile(wb, filename);
  showToast("Planilha Excel gerada com sucesso!","success");
}
;

window.finalizarTurno = function () {
  if (confirm("Confirmar finaliza√ß√£o do turno e limpar dados?")) {
    lacres = [];
    actionHistory = [];
    saveState();
    atualizarTabela();
    showToast("Turno finalizado com sucesso!","success");

    document.getElementById("numeroLacre").value = "";
    document.getElementById("quantidadeLacres").value = "";
    document.getElementById("auxiliar").value = "";

    const usuario = localStorage.getItem("usuario") || "";
    const registro = localStorage.getItem("registro") || "";
    document.getElementById("conferente").value = usuario && registro ? `${usuario} - ${registro}` : usuario;
  }
};

window.toggleTable = function () {
  const tbl = document.getElementById("tabelaLacres");
  const btn = document.getElementById("toggleTableBtn");
  if (tbl.style.display === "none") {
    tbl.style.display = "table";
    btn.textContent = `üö´ Esconder tabela (${lacres.length})`;
  } else {
    tbl.style.display = "none";
    btn.textContent = `üëÅÔ∏è Visualizar tabela (${lacres.length})`;
  }
};

document.addEventListener("DOMContentLoaded", () => {
  const usuario = localStorage.getItem("usuario") || "";
  const registro = localStorage.getItem("registro") || "";
  document.getElementById("numeroLacre").value = localStorage.getItem("numeroLacre") || "";
  document.getElementById("quantidadeLacres").value = localStorage.getItem("quantidadeLacres") || "";
  document.getElementById("auxiliar").value = localStorage.getItem("auxiliar") || "";
  document.getElementById("conferente").value = usuario && registro ? `${usuario} - ${registro}` : usuario;

  document.getElementById("numeroLacre").focus();
  atualizarTabela();
  if (lacres.length > 0) showToast("Sess√£o restaurada","success");
});

// === UX Helpers: Toasts & Confirm Modal ===
function showToast(msg, type = "success", timeout = 3200) {
  const wrap = document.getElementById("toastContainer");
  if (!wrap) return;
  const el = document.createElement("div");
  el.className = "toast " + (type||"");
  el.textContent = msg;
  wrap.appendChild(el);
  setTimeout(() => { el.style.opacity = "0"; el.style.transition = "opacity .4s"; }, timeout-400);
  setTimeout(() => el.remove(), timeout);
}

function openConfirm(message) {
  return new Promise(resolve => {
    const overlay = document.getElementById("confirmOverlay");
    const msg = document.getElementById("confirmMessage");
    const ok = document.getElementById("confirmOkBtn");
    const cancel = document.getElementById("confirmCancelBtn");
    msg.textContent = message || "Confirmar?";
    const cleanup = (result) => {
      overlay.style.display = "none";
      ok.onclick = cancel.onclick = null;
      resolve(result);
    };
    ok.onclick = () => cleanup(true);
    cancel.onclick = () => cleanup(false);
    overlay.style.display = "flex";
  });
}

window.addEventListener("beforeunload", saveState);
</script>

</body>
</html>